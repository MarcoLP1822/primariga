name: Release - Production

on:
  push:
    branches: [main]
    tags:
      - 'v*'

jobs:
  # Versioning automatico
  version:
    name: ðŸ“¦ Version Bump
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Check if version needs bump
        id: version-check
        run: |
          # Placeholder per logica di versioning
          echo "needs_bump=false" >> $GITHUB_OUTPUT

  # Deploy su production (solo su tag)
  deploy-production:
    name: ðŸš€ Deploy Production
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run all tests
        run: npm test

      - name: ðŸ—ï¸ Build production
        run: npm run type-check
        env:
          NODE_ENV: production

      - name: ðŸ“± Prepare EAS build instructions
        run: |
          echo "## ðŸš€ Production Release ${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Run EAS build for production" >> $GITHUB_STEP_SUMMARY
          echo "2. Submit to App Store / Google Play" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Commands:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npx eas build --profile production --platform all" >> $GITHUB_STEP_SUMMARY
          echo "npx eas submit --platform android" >> $GITHUB_STEP_SUMMARY
          echo "npx eas submit --platform ios" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Notifica release
  notify:
    name: ðŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ðŸ“¢ Create Release Notes
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Release ${tag}`,
              body: 'ðŸš€ Production release deployed!',
              draft: false,
              prerelease: false
            });
