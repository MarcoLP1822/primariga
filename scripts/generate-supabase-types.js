#!/usr/bin/env node

/**
 * Script per generare types TypeScript da Supabase
 *
 * Usage:
 *   node scripts/generate-supabase-types.js
 *
 * Richiede variabili d'ambiente:
 *   SUPABASE_PROJECT_ID o SUPABASE_DB_URL
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

const OUTPUT_FILE = path.join(__dirname, '..', 'src', 'data', 'supabase', 'types.generated.ts');
const PROJECT_ID = process.env.SUPABASE_PROJECT_ID;
const DB_URL = process.env.SUPABASE_DB_URL;

console.log('üîÑ Generazione types Supabase...\n');

try {
  // Verifica che Supabase CLI sia installato
  try {
    execSync('supabase --version', { stdio: 'ignore' });
  } catch {
    console.error('‚ùå Supabase CLI non installato!');
    console.log('\nüì¶ Installalo con: npm install -g supabase');
    process.exit(1);
  }

  // Crea directory se non esiste
  const dir = path.dirname(OUTPUT_FILE);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }

  let command;

  if (PROJECT_ID) {
    console.log(`üìã Usando Project ID: ${PROJECT_ID}`);
    command = `supabase gen types typescript --project-id ${PROJECT_ID}`;
  } else if (DB_URL) {
    console.log('üìã Usando Database URL');
    command = `supabase gen types typescript --db-url "${DB_URL}"`;
  } else {
    console.error('‚ùå Manca SUPABASE_PROJECT_ID o SUPABASE_DB_URL in .env');
    console.log('\nüí° Aggiungi al file .env:');
    console.log('   SUPABASE_PROJECT_ID=your-project-id');
    console.log('   oppure');
    console.log('   SUPABASE_DB_URL=postgresql://...');
    process.exit(1);
  }

  // Genera types
  console.log('‚öôÔ∏è  Generando types...\n');
  const types = execSync(command, { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 });

  // Aggiungi header al file
  const header = `/**
 * Supabase Database Types
 * 
 * Auto-generated by Supabase CLI
 * DO NOT EDIT MANUALLY
 * 
 * Generated: ${new Date().toISOString()}
 * 
 * To regenerate:
 *   npm run types:generate
 */

`;

  // Scrivi file
  fs.writeFileSync(OUTPUT_FILE, header + types);

  console.log('‚úÖ Types generati con successo!');
  console.log(`üìÑ File: ${OUTPUT_FILE}\n`);

  // Mostra statistiche
  const lines = types.split('\n').length;
  console.log(`üìä Statistiche:`);
  console.log(`   - Linee: ${lines}`);
  console.log(`   - Dimensione: ${(types.length / 1024).toFixed(2)} KB\n`);
} catch (error) {
  console.error('\n‚ùå Errore durante la generazione:');
  console.error(error.message);

  if (error.stderr) {
    console.error('\nDettagli errore:');
    console.error(error.stderr.toString());
  }

  process.exit(1);
}
